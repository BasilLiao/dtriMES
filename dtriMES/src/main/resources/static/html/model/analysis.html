<style>
#固定第一欄位
.st1 {
	left: 1px;
}

#固定第二欄位
.st2 {
	left: 161px;
}

.datalist {
	overflow: hidden;
	text-overflow: ellipsis;
}
</style>
<!-- 統計報告 -->
<div id="analysis">
	<!-- 欄位 -->
	<!-- col-md-2/4/6/8/10/12 -->
	<div class="shadow row text-left mb-2 m-0">
		<div class="col-12 bg-white rounded-top m-0 pl-1 h4 mb-1 row">
			<div class="col-2 p-0">
				<i class="bi bi-file-earmark-spreadsheet mr-1"></i>Columns
			</div>
			<div class="col-10 p-0">
				<i class="bi bi-card-checklist mr-1"></i>Select
			</div>
		</div>
		<!-- 欄位 -->
		<div id="column_scroll" class="col-2 p-2 m-0" style="overflow-y: auto; max-height: 515px;">
			<div class="col-12 m-0 p-0">
				<div class="m-0 p-0 border border-secondary rounded-top shadow bg-white">
					<div class="col-12 h5 m-0 p-1 pl-2 mb-2 text-white rounded-top bg-dark">Step1. choose ?</div>
					<div class="row m-0 p-1">
						<div class="col-8 p-1 border border-secondary">查詢欄位</div>
						<div class="col-4 p-1 border border-secondary">顯示</div>
					</div>
					<div id="columns_sample" class="col-md-12 p-0 m-0 d-none">
						<!-- 每個選項 -->
						<div class="columns_list p-1 m-1 border border-secondary rounded shadow bg-white">
							<!-- 欄位資料 -->
							<div class="row d-none">
								<input value="" name="欄位" class="col-8 p-0 column_name" type="text"> <input value="" name="名稱" class="col-8 p-0 column_exp" type="text">
							</div>
							<!-- 添加條件 -->
							<div class="m-0 p-0 row">
								<button id="btn_columns_sample" class="col-10 m-0 p-1 btn btn-primary btn-sm column_add" type="button" style="line-height: 15px;">Add select</button>
								<!-- Show? -->
								<input value="" name="" class="col-2 m-0 mt-1 p-1" type="checkbox" style="height: 20px;" checked="checked">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 條件 -->
		<div class="col-10 row p-1 m-0">
			<div class="col-8 m-0 p-0">
				<div class="row m-1 mt-1 p-0 border border-secondary rounded-top shadow bg-white">
					<div class="col-12 h5 m-0 mb-2 pl-2 p-1 text-white rounded-top bg-dark">Step2.Select value ?</div>
					<div class="d-none">
						<div class="col-md-4 p-1 m-0">
							<input id="where_key" value="" name="" class="p-1 col-md-12 m-0" type="text" disabled="disabled">
						</div>
						<div class="col-md-8 p-1 m-0">
							<input id="where_value" value="" name="" class="p-1 col-md-12 m-0" type="text" disabled="disabled" placeholder="Ex:XXXX LIKE '%${data}%'">
						</div>
					</div>
					<!-- 條件 -->
					<div class="col-md-12 row p-0 m-0">
						<div class="col-3 p-1">
							<input id="chooes_show" value="" name="" class="p-1 col-md-12 m-0" type="text" disabled="disabled" placeholder="Ex:工單號 ">
						</div>
						<div class="col-md-2 p-1 m-0">
							<select class="col-md-12 p-1" id="fm_select">
								<option class="select_option" value="select_notthing">選擇條件</option>
								<option class="select_option" value="select_like">包含有</option>
								<option class="select_option" value="select_notsame">完全相同</option>
								<option class="select_option" value="select_same">完全不同</option>
								<option class="select_option" value="select_small">小於區間</option>
								<option class="select_option" value="select_bigger">大於區間</option>
							</select>
						</div>
						<div class="col-md-3 p-1 m-0">
							<select class="col-md-12 p-1" id="fm_type">
								<option value="fm_word" selected>Text(文字)</option>
								<option value="fm_nb">Number(數字)</option>
								<option value="fm_time">Date Time(時間)</option>
							</select>
						</div>
						<div class="col-md-4 p-1 m-0">
							<!-- 文字 -->
							<input id="fm_word_value" value="" name="" class="fm_value col-md-12 p-1 m-0" type="text" placeholder="Value[Text]=${data1,2}">
							<!-- 數字 -->
							<input id="fm_nb_value" value="" name="" class="fm_value col-md-12 p-1 m-0 d-none" type="number" placeholder="Value[Number]=${data1,2}">
							<!-- 時間 -->
							<input id="fm_time_value" value="" name="" class="fm_value col-md-12 p-1 m-0 d-none datetimepicker_date" type="text" placeholder="Value[Date Time]=${data1,2}">
						</div>
					</div>
					<div class="col-12 row m-0 p-0 mt-2">
						<div class="col"></div>
						<button id="where_value_add" class="col m-1 p-1 btn btn-primary btn-sm" type="button">Add to list</button>
						<button id="where_value_clear" class="col m-1 p-1 btn btn-warning btn-sm" type="button">Clear</button>
					</div>
				</div>
				<div class="row m-1 mt-2 p-0 border border-secondary rounded-top shadow bg-white">
					<div class="col-12 h5 m-0 mb-2 pl-2 p-1 text-white rounded-top bg-dark">Query list</div>
					<div class="col-12 m-0 p-0">
						<!-- 樣本 -->
						<div id="list_i" class="row p-0 m-1 border border-secondary d-none">
							<div class="col-md-1 p-2">
								<i class="bi bi-x-square btn btn-outline-danger p-0 pl-1 pr-1 m-0 list_remove" id="list_where_i"></i>
							</div>
							<div class="col-md-11 h4 mb-0 p-1">
								<input disabled="disabled" value="" name="" class="col list_where_show" type="text" placeholder="">
								<!--  -->
								<input disabled="disabled" value="" name="" class="col list_where_value d-none" type="text" placeholder="">
							</div>
						</div>

						<div class="col-12 row m-0 p-0 mt-2">
							<div class="col"></div>
							<button id="list_search_btn" class="col m-1 p-1 btn btn-primary btn-sm" type="submit">Search</button>
							<button id="list_cancel_btn" class="col m-1 p-1 btn btn-warning btn-sm" type="button">Cancel</button>
						</div>
						<div class="col-12 row m-0 p-1 mt-2">
							<div class="col-8 p-0 progress">
								<div id="pro_bar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%"></div>
							</div>
							<div class="col-4 m-0 p-0 mt-0 small text-danger text-center">The maximum limit is 5,000 Data</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-4 m-0 p-0" style="overflow-y: auto; height: 515px;">
				<div class="col-12 m-0 p-0">
					<div class="row m-1 mt-1 p-0 border border-secondary rounded-top shadow bg-white">
						<div class="col-12 h5 m-0 mb-2 pl-2 p-1 text-white rounded-top bg-dark">History</div>
						<div class="col-12 m-0 p-0">
							<!-- 樣本 -->
							<div id="list_his" class="row p-0 m-1 border border-secondary d-none">
								<div class="col-md-1 p-1 pt-2">
									<i class="bi bi-plus-square btn btn-outline-success p-0 pl-1 pr-1 m-0 list_add" id="list_where_his"></i>
								</div>
								<div class="col-md-11 h4 mb-0 p-1">
									<input disabled="disabled" value="" name="" class="col list_his_show" type="text" placeholder="">
									<!--  -->
									<input disabled="disabled" value="" name="" class="col list_his_value d-none" type="text" placeholder="">
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 報告 -->
	<div class=" shadow mt-0 text-left mb-2">
		<div class="bg-white rounded-top m-0 pl-1 h4 row justify-content-between">
			<div class="col-md-5 p-0">
				<i class="bi bi-graph-up mr-1"></i>Report
			</div>
			<div class="col-md-2 p-0 mr-2">
				<button id="export_excel_report" class="col-md-12 m-0 p-1 btn btn-primary btn-sm" type="button">Export excel report</button>
			</div>
		</div>
		<div class="row p-0 m-0">
			<div class="col-md-12 m-0 p-2">
				<table id="report_excel_example" class="table table-sm table-hover table-striped table-bordered table-responsive m-0" style="min-height: 620px; max-height: 620px;">
					<thead id="report_excel_header" class="thead bg-dark table-dark">
						<tr style="position: sticky; top: 0px; background-color: #343a40; z-index: 5;">
							<th id="report_excel_th" class="text-center" style="min-width: 150px;" nowrap="nowrap">計數</th>
						</tr>
					</thead>
					<tbody id="report_excel_body">
						<tr id="report_excel_tbody_tr" class="noExl d-none">
							<td class="report_excel_td" nowrap="nowrap"></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
//控制端
analysis = new Vue({
	el: "#analysis",
	//資料區
	data: {
		test: 300,
		list_id: 0,
		reportDate: "",
	},
	//初始化
	created() {
		console.log("analysis.html(created)");
	},
	//可呼叫方法
	methods: {
		setDataTitle(title, analysis) {
			console.log(title);
			//console.log(analysis);

			title = main.orderedSort(title);
			var ii = 0; //有效欄位
			var left_ii = 1; //有效靠左
			for (var i = 0; i < Object.keys(title).length - 1; i++) {
				var key_id = (Object.keys(title)[i]).split("_h__")[1];
				var value_name = title[Object.keys(title)[i]].name,
					value_size = title[Object.keys(title)[i]].size,
					value_write = title[Object.keys(title)[i]].write;
				
				if (analysis[key_id] != "W_N") {
					//Columns(選擇清單)
					var one_item = $("#columns_sample").clone(); //複製樣本
					one_item[0].id = "columns_" + key_id;
					one_item.insertBefore("#columns_sample");
					$("#" + one_item[0].id).removeClass("d-none");
					$("#" + one_item[0].id + " .column_name").val(key_id);
					$("#" + one_item[0].id + " .column_exp").val(value_name);
					$("#" + one_item[0].id + " button").attr("id", "btn_" + one_item[0].id);
					$("#" + one_item[0].id + " button").text(value_name);
					
					//Report(報告欄位)
					var report_header = $("#report_excel_th").clone(); //複製樣本
					var report_body = $(".report_excel_td").clone();
					report_header[0].id = "report_t_" + key_id;
					report_header.insertBefore("#report_excel_th");
					report_body[0].id= "report_b_" + key_id;
					report_body[0].className = "";
					report_body.insertBefore(".report_excel_td");
					$("#" + report_header[0].id).text(value_name).css('max-width', value_size).css('min-width', value_size);
					$("#" + report_body[0].id).text("");
					//.css('max-width', value_size).css('min-width', value_size).css('overflow', 'hidden');
					
					//固定
					if (ii < 2) {
						$("#" + report_header[0].id).addClass('fixed_cell').addClass('bg-dark').css('left', left_ii);
						$("#" + report_body[0].id).addClass('fixed_cell').css('left', left_ii);
						ii += 1;
						left_ii += parseInt(value_size);
					}
				}
			}
		},
		setAllInit() {
			//時間格式
			$('#analysis .datetimepicker_date').datetimepicker({
				format: 'yyyy-mm-dd hh:ii:00',
				pickerPosition: 'bottom-right',
				//minView:1,
				// hoursDisabled: [00, 1, 2, 3, 4, 5, 6],
				minuteStep: 30,
				autoclose: true,
				endDate: '+1d',
				datesDisabled: '+1d',
				todayBtn: true,
				//......可以同上項目代碼自定義設置
			});
			
			$("#where_value_add").attr("disabled", "disabled");
			$("#list_search_btn").attr("disabled", "disabled");

			//========choose========
			$(document).on("click", ".column_add", function(event) {
				var id = event.target.id.replace('btn_columns_', '');
				$("#where_key").val($("#columns_" + id + " .column_name").val());
				$("#chooes_show").val($("#columns_" + id + " .column_exp").val());
				//$(".column_add").attr("disabled", "disabled");

				if($("#fm_select").find(":selected").val()!="select_notthing" ){
					//$(".column_add").attr("disabled", "disabled");
					$("#where_value_add").removeAttr("disabled");					
				}
			});

			//========Select value======== 
			$(document).on("click", "#fm_select", function() {
				if($("#chooes_show").val()==""){
					return null;//如果沒有選項目
				}
				$("#where_value").val("");
				switch ($(this).find(":selected").val()) {
					case "select_notthing":
						$("#where_value_add").attr("disabled", "disabled");
						return null;
					break;
					case "select_like":
						$("#where_value").val($("#where_value").val() + " Like '%${data2}%' ");
						break;
					case "select_notsame":
						$("#where_value").val($("#where_value").val() + " = ${data2} ");
						break;
					case "select_same":
						$("#where_value").val($("#where_value").val() + " != ${data2} ");
						break;
					case "select_small":
						$("#where_value").val($("#where_value").val() + " < ${data2} ");
						break;
					case "select_bigger":
						$("#where_value").val($("#where_value").val() + " > ${data2} ");
						break;
				}
				//$(".column_add").attr("disabled", "disabled");
			
				$("#where_value_add").removeAttr("disabled");
				
			});
			//========Query list========
			$(document).on("click", "#where_value_add", function(event) {
				//添加條件式
				var where_value = $("#fm_word_value").val();
				if (where_value == "") {
					where_value = $("#fm_nb_value").val();
					if (where_value == "") {
						where_value = $("#fm_time_value").val();
						where_value = "'" + where_value + "'";
					}
				} else {
					where_value = "'" + where_value + "'";
				}
				//排除
				if ($("#where_value").val().indexOf("Like") > 0) {
					where_value = where_value.replaceAll("'", "");
				}

				if ($("#where_value").val() != "" && where_value != "") {
					if ($("#where_value").val().indexOf("betweet") > 0 && $("#where_value").val().indexOf("${data1}") > 0) {
						$("#where_value").val($("#where_value").val().replace('${data1}', where_value));
						$("#fm_nb_value").val("");
						$("#fm_word_value").val("");
						$("#fm_time_value").val("");
						return false;
					}
					//按鈕鎖定
					$(".column_add").removeAttr("disabled");
					
					$("#where_value_add").attr("disabled", "disabled");
					$("#list_search_btn").removeAttr("disabled");
					//添加清單
					var one_item = $("#list_i").clone(); //複製樣本
					one_item[0].id = "list_" + (analysis.list_id += 1);
					one_item.insertBefore("#list_i");
					$("#" + one_item[0].id + " .list_where_value").val($("#where_key").val()+$("#where_value").val().replace('${data2}', where_value));
					$("#" + one_item[0].id + " .list_where_show").val($("#chooes_show").val()+" "+$("#fm_select").find(":selected").text()+" "+where_value);
					
					$("#" + one_item[0].id + " #list_where_i").attr("id", "list_where_" + analysis.list_id);
					$("#" + one_item[0].id).removeClass("d-none");
					$("#" + one_item[0].id).addClass("list_where");

					//清空
					//$("#where_value").val("");
					//$("#where_key").val("");
					$("#fm_nb_value").val("");
					$("#fm_word_value").val("");
					$("#fm_time_value").val("");
				}
			});
			$("#fm_type").change(function() {
				$(".fm_value").val("");
				$(".fm_value").addClass("d-none");
				$("#" + $("#fm_type option:selected").val() + "_value").removeClass("d-none");
			}).change();

			$(document).on("click", "#where_value_clear", function(event) {
				//清空
				$("#where_value").val("");
				$("#fm_nb_value").val("");
				$("#fm_word_value").val("");
				$("#fm_time_value").val("");

				$(".column_add").removeAttr("disabled");
				
				$("#where_value_add").attr("disabled", "disabled");
			});
			//========Search list========
			$(document).on("click", ".list_remove", function(event) {
				$("#list" + event.target.id.replace('list_where', '')).remove();
			});
			$(document).on("click", "#list_cancel_btn", function(event) {
				$(".list_where").remove();
				$(".report_excel_list").remove();
			});
			$(document).on("click", "#list_search_btn", function(event) {
				
				var search = $(".list_where .list_where_value").map((index, el) => el.value);
				var show = $(".list_where .list_where_show").map((index, el) => el.value);
				for (var a = 0; a < search.length; a++) {
					var one_item = $("#list_his").clone(); //複製樣本
					one_item[0].id = "list_" + (analysis.list_id += 1);
					one_item.insertBefore("#list_his");
					$("#" + one_item[0].id + " .list_his_value").val(search[a]);
					$("#" + one_item[0].id + " .list_his_show").val(show[a]);
					
					$("#" + one_item[0].id + " #list_where_his").attr("id", "list_where_" + analysis.list_id);
					$("#" + one_item[0].id).removeClass("d-none");
					$("#" + one_item[0].id).addClass("list_where");
				}
				
				analysis.reportSend();
			});

			//========report========

			$(document).on("click", "#export_excel_report", function(event) {
				$("#report_excel_example").table2excel({
					// exclude CSS class
					//https://www.jqueryscript.net/table/Export-Html-Table-To-Excel-Spreadsheet-using-jQuery-table2excel.html
					preserveColors: false,
					exclude_img: true,
					exclude_links: true,
					exclude: ".noExl",
					name: "Worksheet Name",
					filename: "MES_Report_" + analysis.reportDate, //do not include extension
					fileext: ".xls" // file extension
				});
			});
		},
		proBar(total,nowqty){
			var p = (nowqty*100)/total;
			$("#pro_bar").text(nowqty+"/"+total);
			$("#pro_bar").attr("aria-valuenow",p);
			$("#pro_bar").css("width",p+"%");
			
		},
		reportSend() {
			//https://ithelp.ithome.com.tw/articles/10215281
			//例遍 處理
			main.loading(true);
			var search_arr = [];
			var search = $(".list_where .list_where_value").map((index, el) => el.value);
			for (var a = 0; a < search.length; a++) {
				search_arr.push("" + analysis.stringToBytes(search[a]));
			}
			console.log(search_arr);
			//包裝
			var s_url = (t_body.html_body + ".RT").replace("html", "basil").replace("body_", "");
			var s_type = "POST";
			var s_data = {};
			var req = {};
			req.user = "" + $('#name').text();
			req.date = new Date();
			req.action = "RT";
			req.body = {};
			req.body.search = search_arr;
			req.page_total = 0;
			req.page_batch = 0;
			req.page_now_nb = 0;
			req.html_body = "";
			req.call_bk_fn = "report";
			req.call_bk_vals = {};
			s_data.req_content = req;

			//console.log(s_url);
			this.proBar(100,10);
			//傳送
			main.ajaxSend(s_url, s_type, s_data);
		},
		reportReturn() {
			//更新時間
			var myDate = new Date();
			analysis.reportDate =
				myDate.getFullYear() + '-' +
				('0' + (myDate.getMonth() + 1)).slice(-2) + '-' +
				('0' + myDate.getDate()).slice(-2) + ' ' + myDate.getHours() + ':' +
				('0' + (myDate.getMinutes())).slice(-2) + ':' + myDate.getSeconds();

			console.log("reportReturn");
			if (main.allData.body != null) {
				var list = main.allData.body.search;
				$(".report_excel_list").remove();
				var fixed_cell_color = false;
				console.log(new Date());
				var list_length = list.length ;
				var key_length = Object.keys(list[0]).length;
				var report_item = "";
				this.proBar(list_length,0);
				var key_id = null, report_item_one = null, i = 0, rep_i_one = "",ii = 0; /*有效欄位*/
				for (var j = 0; list_length > j; j++) {
					report_item = $("#report_excel_tbody_tr").clone(); /*複製樣本*/
					report_item[0].id = "report_excel_tbody_tr_" + j;
					report_item[0].className = "report_excel_list";
					list[j] = main.orderedSort(list[j]);/*排序*/
					
					/*資料內容*/
					key_id = null, report_item_one = null, i = 0, rep_i_one = "",ii = 0; /*有效欄位*/
					for (i = 0; i < key_length; i++) {		
						//資料
						key_id = (Object.keys(list[j])[i]).split("_b__")[1];/*Ex:"01_b__pr_id"*/
						value_name = list[j][Object.keys(list[j])[i]];
						/*取得Report位置 : 如果*/
						if(report_item[0].children[i]==null){continue;}/*如果沒有此欄位*/
						report_item[0].children[i].className="report_" + key_id;
						report_item[0].children[i].id = "";
						report_item[0].children[i].innerHTML = value_name;
						/*固定*/
						if (ii < 2) {
							report_item[0].children[i].className="report_" + key_id+" fixed_cell";
							if (fixed_cell_color) {
								report_item[0].children[i].style.backgroundColor = "#f8f9fc";
							} else {
								report_item[0].children[i].style.backgroundColor = "#ebecef";
							}ii += 1;
						}
					}
					report_item[0].children[i].innerHTML = j+1;/* 計數器*/
					report_item.insertBefore("#report_excel_tbody_tr");
					if (fixed_cell_color) {fixed_cell_color = false;
					}else {fixed_cell_color = true;}
				}
				this.proBar(list_length,j);
				console.log(new Date());
			}else{
				this.proBar(100,0);
			}
			main.loading(false);
		},
		//轉Bytes
		stringToBytes(str) {
			var ch, st, re = [];
			for (var i = 0; i < str.length; i++) {
				ch = str.charCodeAt(i);
				st = [];
				do {
					st.push(ch & 0xFF);
					ch = ch >> 8;
				} while (ch);
				re = re.concat(st.reverse());
			} // return an array of bytes  
			return re;
		},
	},
	//移除監聽事件
	beforeDestroy() {
		console.log("analysis.html(beforeDestroy)");
		$(document).off("click", ".column_add");
		$(document).off("click", ".fm_select");
		$(document).off("click", "#where_value_clear");
		$(document).off("click", "#where_value_add");
		$(document).off("click", ".list_remove");
		$(document).off("click", "#list_cancel_btn");
		$(document).off("click", "#list_search_btn");
		
		$(document).off("click", "#export_excel_report");
	},
});
</script>